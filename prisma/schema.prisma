generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==============================
// ENUMS
// ==============================
enum Role {
  ADMIN
  CUSTOMER
}

enum StatusPembayaran {
  BELUM
  MENUNGGU_VERIFIKASI
  VALID
  INVALID
}

enum StatusPesanan {
  DIBUAT
  MENUNGGU_DP
  DIPROSES
  MENUNGGU_PELUNASAN
  SELESAI
  DIBATALKAN
}

enum JenisPembayaran {
  DP
  PELUNASAN
  FULL
}

// ==============================
// MODELS
// ==============================

model User {
  id_user  Int     @id @default(autoincrement())
  nama     String
  email    String  @unique
  password String
  no_hp    String
  alamat   String?
  role     Role    @default(CUSTOMER)

  pesanan Pesanan[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([role])
}

model Produk {
  id_produk           Int     @id @default(autoincrement())
  nama_produk         String
  deskripsi           String
  harga               Int
  estimasi_pengerjaan Int
  bahan               String
  foto                String?

  pesanan Pesanan[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([nama_produk])
  @@index([harga])
}

model Pesanan {
  id_pesanan Int @id @default(autoincrement())

  // ðŸ”‘ FOREIGN KEY
  id_user   Int
  id_produk Int

  qty          Int
  harga_satuan Int
  total_harga  Int
  dp_wajib     Int

  catatan String?

  dp_status        StatusPembayaran @default(BELUM)
  pelunasan_status StatusPembayaran @default(BELUM)
  status_pesanan   StatusPesanan    @default(MENUNGGU_DP)

  tanggal_pesan DateTime @default(now())

  user   User   @relation(fields: [id_user], references: [id_user])
  produk Produk @relation(fields: [id_produk], references: [id_produk])

  transaksi TransaksiPembayaran[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([id_user])
  @@index([id_produk])
  @@index([status_pesanan])
}

model TransaksiPembayaran {
  id_transaksi Int @id @default(autoincrement())
  id_pesanan   Int

  jenis_pembayaran JenisPembayaran
  jumlah           Int

  // ============================
  // FIELD MIDTRANS ONLY
  // ============================
  midtrans_order_id        String    @unique
  midtrans_transaction_id  String?
  midtrans_payment_type    String?
  midtrans_va_number       String?
  midtrans_qr_url          String? // untuk QRIS
  midtrans_redirect_url    String? // GoPay / card
  midtrans_status          String? // pending, deny, expire, settlement, cancel
  midtrans_settlement_time DateTime?

  pesanan Pesanan @relation(fields: [id_pesanan], references: [id_pesanan])

  tanggal_upload DateTime @default(now())

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([id_pesanan])
  @@index([jenis_pembayaran])
  @@index([midtrans_order_id])
  @@index([midtrans_status])
}
